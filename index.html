<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é•œåƒèƒ½é‡æŠ½å¡ç³»ç»Ÿ (v14 å®Œç¾ä¿®å¤ç‰ˆ)</title>
    <style>
        :root {
            --card-width: 140px;
            --card-height: 250px;
            --primary-gold: #d4af37;
            --bg-color: #000000;
        }

        /* ================= ç§»åŠ¨ç«¯é€‚é… ================= */
        @media (max-width: 768px) {
            :root {
                --card-width: 85px;
                --card-height: 150px;
            }
            #step-container { width: 90% !important; padding: 25px 15px !important; margin-top: 20px !important; }
            .layout-3 { gap: 15px !important; }
            .layout-5 { gap: 10px !important; }
            
            #right-sidebar { top: auto !important; bottom: 20px !important; right: 20px !important; transform: none !important; flex-direction: row !important; }
            #lock-btn { width: 50px !important; height: 50px !important; font-size: 20px !important; }
            .sidebar-tooltip { display: none !important; }
            #history-content, #replace-content { width: 85% !important; max-height: 80vh !important; }
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: #ecf0f1;
            margin: 0;
            overflow-x: hidden;
            display: flex; flex-direction: column; height: 100vh;
            /* å…³é”®ï¼šç¦æ­¢ç§»åŠ¨ç«¯çš„é«˜äº®å’Œé»˜è®¤æ‰‹åŠ¿ */
            -webkit-tap-highlight-color: transparent;
        }

        /* å¼•å¯¼é¡µ */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease;
        }
        #intro-img { width: 150px; height: auto; margin-bottom: 40px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.1)); }
        .intro-text { font-size: 20px; letter-spacing: 3px; font-weight: 300; margin-bottom: 50px; font-family: 'KaiTi', serif; color: #aaa; text-align: center; }
        .enter-btn {
            padding: 10px 40px; background: transparent; border: 1px solid #666; color: #d4af37;
            font-size: 16px; border-radius: 30px; text-transform: uppercase; letter-spacing: 2px;
        }

        /* å¯¼èˆª */
        #navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; box-sizing: border-box; z-index: 5000; pointer-events: none; 
        }
        .nav-btn {
            pointer-events: auto; background: rgba(0,0,0,0.8); border: 1px solid #444; color: #ccc;
            padding: 6px 12px; border-radius: 4px; font-size: 13px; display: flex; align-items: center; gap: 5px;
        }

        /* ä¸»ç•Œé¢ */
        #main-app {
            display: none; flex-direction: column; align-items: center; width: 100%; min-height: 100vh; padding-top: 50px; 
        }

        #step-container {
            margin-top: 50px; text-align: center; background: rgba(20, 20, 20, 0.95);
            border: 1px solid #333; padding: 40px; border-radius: 8px; max-width: 600px; width: 90%; z-index: 100;
        }
        .step-section { display: none; animation: fadeIn 0.5s; }
        .step-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { color: var(--primary-gold); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; font-size: 1.2rem; }
        .action-btn {
            padding: 12px 30px; background-color: var(--primary-gold); color: #000;
            border: none; border-radius: 4px; font-weight: bold; font-size: 16px; margin-top: 25px;
        }
        
        label { margin: 0 10px; cursor: pointer; font-size: 16px; display:inline-block; margin-bottom:10px; }
        input[type="number"] {
            background: #222; border: 1px solid #555; color: #fff;
            padding: 10px; width: 50px; text-align: center; margin: 5px;
            font-size: 16px; border-radius: 4px;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        #game-area {
            flex-grow: 1; width: 100%; display: flex; justify-content: center; align-items: center;
            position: relative; padding-bottom: 80px; padding-top: 20px; box-sizing: border-box;
        }

        .layout-container { display: grid; justify-items: center; align-items: center; }
        .layout-1 { grid-template-columns: 1fr; }
        
        /* 3å¼ ç‰Œå¸ƒå±€ï¼šå¼ºè¡Œå›ºå®šä¸º1åˆ— */
        .layout-3 { 
            grid-template-columns: 1fr; 
            grid-template-rows: repeat(3, auto); 
            gap: 20px; 
        }
        
        .layout-5 {
            display: grid; grid-template-columns: repeat(3, var(--card-width));
            grid-template-rows: repeat(3, var(--card-height)); gap: 15px;
        }
        .slot-pos-0 { grid-column: 2; grid-row: 2; } 
        .slot-pos-1 { grid-column: 1; grid-row: 2; } 
        .slot-pos-2 { grid-column: 3; grid-row: 2; } 
        .slot-pos-3 { grid-column: 2; grid-row: 1; } 
        .slot-pos-4 { grid-column: 2; grid-row: 3; } 

        .card-slot {
            width: var(--card-width); height: var(--card-height);
            border: 1px dashed #444; background-color: rgba(255, 255, 255, 0.02);
            border-radius: 6px; position: relative; display: flex; justify-content: center; align-items: center;
        }
        .card-slot.drag-over { border-color: var(--primary-gold); box-shadow: 0 0 10px rgba(212,175,55,0.2); }

        .card-entity {
            width: 100%; height: 100%; perspective: 1000px; position: relative; z-index: 10;
            /* å…³é”®ä¿®å¤ï¼šè®©è§¦æ‘¸äº‹ä»¶ç”Ÿæ•ˆï¼Œè€Œä¸è¢«å½“æˆæ»šåŠ¨ */
            touch-action: none; 
        }
        .card-entity.dragging-mobile { opacity: 0.4; }

        /* æ¡Œé¢ç«¯æ‹–æ‹½æ—¶éšè—æ­£é¢çš„CSSè¾…åŠ© */
        .card-entity:not(.flipped).dragging .card-front {
            display: none !important;
        }

        .card-inner {
            width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.8); background: #000;
        }
        .card-entity.flipped .card-inner { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; justify-content: center; align-items: center;
            border-radius: 6px; overflow: hidden; background: #111; border: 1px solid #333;
        }
        .card-back {
            background-image: repeating-linear-gradient(45deg, #1a1a1a 0, #1a1a1a 10px, #222 10px, #222 20px);
            color: var(--primary-gold);
        }
        .card-front { transform: rotateY(180deg); background: #000; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .input-num-display {
            font-size: 1.2em; font-weight: bold; border: 1px solid var(--primary-gold);
            border-radius: 50%; width: 30px; height: 30px; line-height: 30px; text-align: center; background: #000;
        }

        .slot-action-btn {
            position: absolute; bottom: -25px; width: 30px; height: 30px;
            background: transparent; border: none; color: #444; 
            display: none; justify-content: center; align-items: center;
            z-index: 50; transition: all 0.4s; font-size: 14px; font-weight: bold;
        }
        .slot-action-btn:hover, .slot-action-btn:active { color: var(--primary-gold); transform: rotate(180deg) scale(1.2); }

        #right-sidebar {
            position: fixed; right: 20px; top: 50%; transform: translateY(-50%);
            display: none; flex-direction: column; gap: 15px;
            z-index: 4000; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 12px;
        }
        #lock-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--primary-gold); border: none; box-shadow: 0 0 15px rgba(212,175,55,0.4);
            font-size: 24px; display: flex; justify-content: center; align-items: center;
        }
        #lock-btn:disabled { background: #333; color: #666; box-shadow: none; }
        .sidebar-tooltip {
            position: absolute; right: 80px; top: 50%; transform: translateY(-50%);
            background: #222; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; 
            opacity: 0; transition: opacity 0.3s;
        }
        #right-sidebar:hover .sidebar-tooltip { opacity: 1; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #111; width: 600px; max-width: 90%; border: 1px solid #333;
            border-radius: 8px; padding: 25px; display: flex; flex-direction: column;
        }
        .history-list { flex-grow: 1; overflow-y: auto; margin-top: 10px; border-top: 1px solid #333; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #222; }
        .h-info { display: flex; flex-direction: column; gap: 5px; flex-grow: 1; }
        .h-name { color: var(--primary-gold); font-weight: bold; font-size: 14px; }
        .h-actions button { background: none; border: none; color: #666; padding: 5px; font-size: 16px; }
        
        #replace-content { text-align: center; padding: 30px; }
        #replace-input {
            background: #222; border: 1px solid #555; color: #fff; padding: 10px;
            font-size: 18px; width: 100px; text-align: center; margin: 20px 0; border-radius: 4px;
        }
        #replace-msg { color: #ccc; line-height: 1.5; font-size: 14px; }
        .modal-btns { display: flex; justify-content: center; gap: 15px; margin-top: 10px; }
        .btn-cancel { background: #333; color: #ccc; border: none; padding: 10px 25px; border-radius: 4px; }
        .btn-confirm { background: var(--primary-gold); color: #000; border: none; padding: 10px 25px; border-radius: 4px; font-weight: bold; }

        #modal-img { max-width: 95%; max-height: 80%; border: 2px solid #333; border-radius: 8px; }
        
        #btn-batch-del {
            background: #c0392b; color: #fff; border: none; padding: 5px 12px; border-radius: 4px;
            font-size: 12px; margin-right: 15px; display: none;
        }
    </style>
</head>
<body>

<div id="intro-screen">
    <img id="intro-img" src="" alt="Enso Circle">
    <div class="intro-text">ä»¥ç¥ä¹‹åå¼€å¯é•œåƒèƒ½é‡</div>
    <button class="enter-btn" onclick="enterSystem()">å¼€å¯è¿æ¥</button>
</div>

<nav id="navbar">
    <button class="nav-btn" onclick="goHome()"><span>ğŸ </span> ä¸»é¡µ</button>
    <button class="nav-btn" onclick="openHistory()"><span>ğŸ“œ</span> è®°å½•</button>
</nav>

<div id="main-app">
    <div id="step-container">
        <div id="step-setup" class="step-section active">
            <h2>é€‰æ‹©ç‰Œé˜µ</h2>
            <div style="margin: 30px 0; display:flex; flex-wrap:wrap; justify-content:center; gap:20px;">
                <label><input type="radio" name="cardCount" value="1"> 1 å¼ </label>
                <label><input type="radio" name="cardCount" value="3"> 3 å¼  (ç«–åˆ—)</label>
                <label><input type="radio" name="cardCount" value="5" checked> 5 å¼  (åå­—)</label>
            </div>
            <button class="action-btn" onclick="goToStepInput()">ä¸‹ä¸€æ­¥ï¼šæ´—ç‰Œ</button>
        </div>

        <div id="step-input" class="step-section">
            <h2>æ„ŸçŸ¥è¿æ¥</h2>
            <p style="color:#888; font-size:12px; margin-bottom: 20px;">ç‰Œå †å·²éšæœºé‡ç½®ã€‚è¯·å‡­ç›´è§‰è¾“å…¥ 1-69 ä¹‹é—´çš„æ•°å­—ã€‚</p>
            <div id="input-container" style="margin: 20px 0; display:flex; flex-wrap:wrap; justify-content:center;"></div>
            <button class="action-btn" onclick="startGame()">å¼€å§‹æŠ½ç‰Œ</button>
        </div>
    </div>

    <div id="game-area"></div>
</div>

<div id="right-sidebar">
    <button id="lock-btn" onclick="lockAndFlip()">ğŸ”’</button>
    <div class="sidebar-tooltip" id="sidebar-hint">é”å®šå¹¶ç¿»ç‰Œ</div>
</div>

<!-- æ¨¡æ€æ¡† -->
<div id="history-modal" class="modal-overlay">
    <div id="history-content" class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0; border:none; font-size:18px;">å†å²è®°å½•</h2>
            <div style="display:flex; align-items:center;">
                <button id="btn-batch-del" onclick="deleteSelected()">åˆ é™¤</button>
                <button onclick="closeModal('history-modal')" style="background:none; border:none; color:#fff; font-size:24px;">âœ•</button>
            </div>
        </div>
        <div style="padding-bottom:10px; border-bottom:1px solid #333;">
            <label style="color:#aaa; font-size:14px;"><input type="checkbox" id="chk-all" onchange="toggleSelectAll(this)"> å…¨é€‰</label>
        </div>
        <div class="history-list" id="history-list-box"></div>
    </div>
</div>

<div id="replace-modal" class="modal-overlay">
    <div id="replace-content" class="modal-content" style="height:auto;">
        <h2 style="border:none; margin-bottom:10px;">æ›´æ¢å¡ç‰Œ</h2>
        <div id="replace-msg"></div>
        <input type="number" id="replace-input" placeholder="åºå·">
        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeModal('replace-modal')">å–æ¶ˆ</button>
            <button class="btn-confirm" onclick="confirmReplace()">ç¡®è®¤æ›´æ¢</button>
        </div>
    </div>
</div>

<div id="image-modal" class="modal-overlay" onclick="closeModal('image-modal')">
    <img id="modal-img" src="" alt="Zoomed Card">
</div>

<script>
    // é…ç½®
    const USE_ONLINE_DEMO = false; 
    const TOTAL_CARDS = 69;

    let deck = [], selectedCount = 5, isFlippingAllowed = false, isReviewMode = false;
    let currentRecord = null;
    let pendingReplaceSlotIndex = null, pendingReplaceSlotElement = null;

    window.onload = function() {
        const introImg = document.getElementById('intro-img');
        if (USE_ONLINE_DEMO) introImg.src = "https://placehold.co/150x150/000/fff?text=Zen";
        else {
            introImg.src = "images/intro.jpg";
            introImg.onerror = function() { this.style.display = 'none'; }
        }
    };

    function enterSystem() {
        document.getElementById('intro-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
        }, 1000);
    }

    function goHome() {
        document.getElementById('step-container').style.display = 'block';
        document.getElementById('game-area').innerHTML = '';
        document.getElementById('right-sidebar').style.display = 'none';
        document.getElementById('step-setup').classList.add('active');
        document.getElementById('step-input').classList.remove('active');
        isFlippingAllowed = false; isReviewMode = false; currentRecord = null;
    }

    function goToStepInput() {
        const radios = document.getElementsByName('cardCount');
        for (let r of radios) if (r.checked) selectedCount = parseInt(r.value);

        deck = Array.from({length: TOTAL_CARDS}, (_, i) => i + 1);
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }

        const container = document.getElementById('input-container');
        container.innerHTML = '';
        for (let i = 0; i < selectedCount; i++) {
            const inp = document.createElement('input');
            inp.type = 'number'; inp.min = 1; inp.max = TOTAL_CARDS;
            inp.placeholder = (selectedCount===3) ? ["ä¸Š","ä¸­","ä¸‹"][i] : `#${i+1}`;
            inp.className = 'user-choice-input';
            container.appendChild(inp);
        }
        document.getElementById('step-setup').classList.remove('active');
        document.getElementById('step-input').classList.add('active');
    }

    function startGame(loadedRecord = null) {
        let inputs, chosenIndices = [];
        if (loadedRecord) {
            selectedCount = loadedRecord.layout;
            deck = loadedRecord.deckSnapshot; 
            isFlippingAllowed = true; isReviewMode = true;
            if (!loadedRecord.finalState) chosenIndices = loadedRecord.userIndices;
        } else {
            inputs = document.querySelectorAll('.user-choice-input');
            for (let inp of inputs) {
                let val = parseInt(inp.value);
                if (isNaN(val) || val < 1 || val > TOTAL_CARDS) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— (1-69)"); return; }
                if (chosenIndices.includes(val)) { alert("æ•°å­—ä¸èƒ½é‡å¤"); return; }
                chosenIndices.push(val);
            }
            isFlippingAllowed = false; isReviewMode = false;
        }

        document.getElementById('step-container').style.display = 'none';
        const gameArea = document.getElementById('game-area');
        gameArea.innerHTML = ''; 
        
        const layoutDiv = document.createElement('div');
        layoutDiv.className = `layout-container layout-${selectedCount}`;
        
        for (let i = 0; i < selectedCount; i++) {
            const slot = document.createElement('div');
            slot.className = (selectedCount === 5) ? `card-slot slot-pos-${i}` : `card-slot`;

            if (!isReviewMode) {
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('drop', handleDrop);
            }

            let realCardId, backNum;
            if (isReviewMode && loadedRecord.finalState) {
                realCardId = loadedRecord.finalState.cardIds[i];
                backNum = loadedRecord.finalState.backNums[i];
            } else if (isReviewMode) {
                const idx = chosenIndices[i]; backNum = idx; realCardId = deck[idx - 1];
            } else {
                const idx = chosenIndices[i]; backNum = idx; realCardId = deck[idx - 1];
            }

            const card = createCard(backNum, realCardId);
            
            if (!isReviewMode) {
                const replaceBtn = document.createElement('div');
                replaceBtn.className = 'slot-action-btn';
                replaceBtn.innerHTML = 'â†»';
                replaceBtn.onclick = (e) => { e.stopPropagation(); openReplaceModal(i, slot); };
                slot.appendChild(replaceBtn);
            }
            
            if (isReviewMode) {
                card.classList.add('flipped');
            } else {
                card.draggable = true; 
                card.addEventListener('dragstart', handleDragStart);
                // ç»‘å®šç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
                card.addEventListener('touchstart', handleTouchStart, {passive: false});
                card.addEventListener('touchmove', handleTouchMove, {passive: false});
                card.addEventListener('touchend', handleTouchEnd);
            }
            
            slot.appendChild(card);
            layoutDiv.appendChild(slot);
        }
        gameArea.appendChild(layoutDiv);

        const sidebar = document.getElementById('right-sidebar');
        const lockBtn = document.getElementById('lock-btn');
        if (isReviewMode) {
            sidebar.style.display = 'none';
        } else {
            sidebar.style.display = 'flex';
            lockBtn.disabled = false;
            document.getElementById('sidebar-hint').innerText = "é”å®šå¹¶ç¿»ç‰Œ";
            prepareRecordData(chosenIndices);
        }
    }

    function createCard(backNum, realId) {
        const entity = document.createElement('div');
        entity.className = 'card-entity';
        entity.dataset.realId = realId; 
        
        let imgSrc = USE_ONLINE_DEMO ? `https://placehold.co/560x1000/222/d4af37?text=Card+${realId}` : `images/${realId}.jpg`;

        entity.innerHTML = `
            <div class="card-inner">
                <div class="card-face card-back"><div class="input-num-display">${backNum}</div></div>
                <div class="card-face card-front"><img src="${imgSrc}" class="card-img" draggable="false"></div>
            </div>
        `;
        
        entity.addEventListener('click', function() {
            if (!isFlippingAllowed) {
                const inner = this.querySelector('.card-inner');
                inner.style.transform = "rotateZ(3deg)"; setTimeout(() => inner.style.transform = "", 100);
            } else {
                if (!this.classList.contains('flipped')) this.classList.add('flipped');
            }
        });

        entity.addEventListener('dblclick', function() {
            if (this.classList.contains('flipped')) {
                document.getElementById('modal-img').src = this.querySelector('.card-img').src;
                document.getElementById('image-modal').style.display = 'flex';
            }
        });
        return entity;
    }

    // ================= ç§»åŠ¨ç«¯æ‹–æ‹½é€»è¾‘ (ä¿®å¤ç‰ˆ) =================
    let touchClone = null, touchSrcSlot = null, touchOffsetX = 0, touchOffsetY = 0;

    function handleTouchStart(e) {
        if (!isFlippingAllowed || isReviewMode) return;
        
        const card = e.currentTarget;
        const touch = e.touches[0];
        touchSrcSlot = card.parentNode;
        
        const rect = card.getBoundingClientRect();
        touchOffsetX = touch.clientX - rect.left;
        touchOffsetY = touch.clientY - rect.top;

        // åˆ›å»ºå…‹éš†ä½“
        touchClone = card.cloneNode(true);
        touchClone.style.position = 'fixed';
        touchClone.style.width = rect.width + 'px';
        touchClone.style.height = rect.height + 'px';
        touchClone.style.zIndex = '9999';
        touchClone.style.pointerEvents = 'none';
        touchClone.classList.add('dragging-mobile');
        
        // å…³é”®ä¿®å¤ï¼šå¦‚æœåŸå¡ç‰Œæ²¡ç¿»å¼€ï¼Œå¼ºåˆ¶éšè—å…‹éš†ä½“çš„æ­£é¢ï¼Œé˜²æ­¢å·çœ‹
        if (!card.classList.contains('flipped')) {
            const front = touchClone.querySelector('.card-front');
            if(front) front.style.display = 'none'; 
        }
        
        touchClone.style.left = (rect.left) + 'px';
        touchClone.style.top = (rect.top) + 'px';
        
        document.body.appendChild(touchClone);
        card.style.opacity = '0.3'; 
    }

    function handleTouchMove(e) {
        if (!touchClone) return;
        e.preventDefault(); // å…³é”®ï¼šé˜»æ­¢æ»šåŠ¨
        const touch = e.touches[0];
        touchClone.style.left = (touch.clientX - touchOffsetX) + 'px';
        touchClone.style.top = (touch.clientY - touchOffsetY) + 'px';
    }

    function handleTouchEnd(e) {
        if (!touchClone) return;
        const card = e.currentTarget;
        card.style.opacity = '1';
        touchClone.remove();
        touchClone = null;

        const touch = e.changedTouches[0];
        card.style.display = 'none'; // æš‚æ—¶éšè—ä»¥æ£€æµ‹åº•éƒ¨å…ƒç´ 
        let target = document.elementFromPoint(touch.clientX, touch.clientY);
        card.style.display = '';

        if (!target) return;
        const targetSlot = target.closest('.card-slot');

        if (targetSlot && targetSlot !== touchSrcSlot) {
            const targetCard = targetSlot.querySelector('.card-entity');
            targetSlot.appendChild(card);
            if (targetCard) touchSrcSlot.appendChild(targetCard);
            updateCurrentRecordState();
            saveHistory(true);
        }
    }

    // ================= æ¡Œé¢ç«¯æ‹–æ‹½é€»è¾‘ (ä¿®å¤ç‰ˆ) =================
    let draggedCard = null;
    function handleDragStart(e) {
        if (isReviewMode) { e.preventDefault(); return; }
        draggedCard = this;
        this.classList.add('dragging'); // è§¦å‘CSSéšè—æ­£é¢
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => this.style.opacity = '0.5', 0);
    }
    function handleDragOver(e) { e.preventDefault(); if (!isReviewMode) e.dataTransfer.dropEffect = 'move'; }
    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('dragging');
        if (isReviewMode || !draggedCard) return;
        const targetSlot = this;
        const sourceSlot = draggedCard.parentNode;
        if (targetSlot !== sourceSlot) {
            const targetCard = targetSlot.querySelector('.card-entity');
            targetSlot.appendChild(draggedCard);
            if (targetCard) sourceSlot.appendChild(targetCard);
            updateCurrentRecordState();
            saveHistory(true);
        }
        draggedCard.style.opacity = '1'; draggedCard.classList.remove('dragging'); draggedCard = null;
    }
    document.addEventListener('dragend', function() {
        if (draggedCard) {
            draggedCard.style.opacity = '1'; draggedCard.classList.remove('dragging');
        }
        draggedCard = null;
    });

    // ================= æ¢ç‰Œé€»è¾‘ =================
    function openReplaceModal(index, slotEl) {
        if(!isFlippingAllowed) return; 
        pendingReplaceSlotIndex = index;
        pendingReplaceSlotElement = slotEl;
        
        const currentCards = document.querySelectorAll('.card-entity');
        const count = TOTAL_CARDS - currentCards.length;
        
        document.getElementById('replace-msg').innerText = `å½“å‰å‰©ä½™ ${count} å¼ ç‰Œã€‚\nè¯·è¾“å…¥ 1 - ${count} ä¹‹é—´çš„æ•°å­—è¿›è¡ŒæŠ½å–ï¼š`;
        document.getElementById('replace-input').value = '';
        document.getElementById('replace-input').max = count;
        document.getElementById('replace-modal').style.display = 'flex';
    }

    function confirmReplace() {
        const inp = document.getElementById('replace-input');
        const val = parseInt(inp.value);
        const currentCards = document.querySelectorAll('.card-entity');
        const usedIds = Array.from(currentCards).map(c => parseInt(c.dataset.realId));
        const max = TOTAL_CARDS - usedIds.length;

        if (isNaN(val) || val < 1 || val > max) { alert("æ— æ•ˆè¾“å…¥"); return; }

        const oldCard = pendingReplaceSlotElement.querySelector('.card-entity');
        const remainingDeck = deck.filter(id => !usedIds.includes(id));
        const newId = remainingDeck[val - 1];

        pendingReplaceSlotElement.removeChild(oldCard);
        
        const backNumText = oldCard.querySelector('.input-num-display').innerText;
        const newCard = createCard(backNumText, newId);
        newCard.draggable = true;
        newCard.addEventListener('dragstart', handleDragStart);
        newCard.addEventListener('touchstart', handleTouchStart, {passive: false});
        newCard.addEventListener('touchmove', handleTouchMove, {passive: false});
        newCard.addEventListener('touchend', handleTouchEnd);
        
        newCard.classList.add('flipped'); // ç›´æ¥ç¿»å¼€
        pendingReplaceSlotElement.appendChild(newCard);

        saveAsNewRecord();
        closeModal('replace-modal');
    }

    // ================= æ•°æ®ä¸å†å² =================
    function prepareRecordData(chosenIndices) {
        currentRecord = {
            id: Date.now(), name: new Date().toLocaleString(),
            layout: selectedCount, userIndices: chosenIndices, 
            deckSnapshot: [...deck], finalState: null
        };
    }
    function updateCurrentRecordState() {
        if (!currentRecord) return;
        const slots = document.querySelectorAll('.card-slot');
        const ids = [], backs = [];
        slots.forEach(slot => {
            const card = slot.querySelector('.card-entity');
            if(card) { ids.push(parseInt(card.dataset.realId)); backs.push(parseInt(card.querySelector('.input-num-display').innerText)); }
        });
        currentRecord.finalState = { cardIds: ids, backNums: backs };
    }
    function lockAndFlip() {
        isFlippingAllowed = true;
        document.getElementById('lock-btn').innerHTML = "âœ“";
        document.getElementById('lock-btn').disabled = true;
        document.getElementById('sidebar-hint').innerText = "æ‹–æ‹½ / æ¢ç‰Œ";
        document.querySelectorAll('.slot-action-btn').forEach(b => b.style.display = 'flex');
        updateCurrentRecordState(); saveHistory(false);
    }
    function saveAsNewRecord() {
        updateCurrentRecordState();
        const newRecord = JSON.parse(JSON.stringify(currentRecord));
        newRecord.id = Date.now();
        if (!newRecord.name.includes("(æ›´æ¢")) newRecord.name += " (æ›´æ¢)";
        else {
            const timeStr = new Date().toLocaleTimeString();
            newRecord.name = newRecord.name.split(" - ")[0] + " - " + timeStr + " (æ›´æ¢)";
        }
        currentRecord = newRecord; saveHistory(false);
    }
    function saveHistory(updateExisting = false) {
        if (!currentRecord) return;
        const list = getHistory();
        if (updateExisting) {
            const idx = list.findIndex(i => i.id === currentRecord.id);
            if (idx !== -1) list[idx] = currentRecord; else list.unshift(currentRecord);
        } else list.unshift(currentRecord);
        localStorage.setItem('mirror_energy_history', JSON.stringify(list));
    }
    function getHistory() { return JSON.parse(localStorage.getItem('mirror_energy_history') || "[]"); }

    // ================= UI è¾…åŠ© =================
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openHistory() {
        const modal = document.getElementById('history-modal');
        const listContainer = document.getElementById('history-list-box');
        const list = getHistory();
        document.getElementById('chk-all').checked = false;
        document.getElementById('btn-batch-del').style.display = 'none';
        listContainer.innerHTML = list.length ? '' : '<div style="color:#666;text-align:center;margin-top:50px;">æš‚æ— è®°å½•</div>';
        
        list.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div style="margin-right:15px;"><input type="checkbox" class="h-item-checkbox" value="${item.id}" onchange="updateBatchBtn()"></div>
                <div class="h-info" onclick="loadHistoryItem(${item.id})">
                    <div class="h-name"><span>${item.name}</span> <span style="font-size:12px;border:1px solid #444;padding:0 5px;">${item.layout}å¼ </span></div>
                    <div class="h-date">${new Date(item.id).toLocaleString()}</div>
                </div>
                <div class="h-actions"><button onclick="editName(${item.id})">âœï¸</button></div>`;
            listContainer.appendChild(div);
        });
        modal.style.display = 'flex';
    }
    function updateBatchBtn() {
        const cnt = document.querySelectorAll('.h-item-checkbox:checked').length;
        const btn = document.getElementById('btn-batch-del');
        btn.style.display = cnt > 0 ? 'block' : 'none';
        btn.innerText = `åˆ é™¤é€‰ä¸­ (${cnt})`;
    }
    function deleteSelected() {
        const chks = document.querySelectorAll('.h-item-checkbox:checked');
        if (!chks.length || !confirm(`åˆ é™¤ ${chks.length} æ¡?`)) return;
        const ids = Array.from(chks).map(c => parseInt(c.value));
        let list = getHistory();
        list = list.filter(i => !ids.includes(i.id));
        localStorage.setItem('mirror_energy_history', JSON.stringify(list));
        openHistory();
    }
    function toggleSelectAll(src) {
        document.querySelectorAll('.h-item-checkbox').forEach(c => c.checked = src.checked);
        updateBatchBtn();
    }
    function editName(id) {
        const name = prompt("æ–°åç§°:");
        if(name) {
            const list = getHistory(); const t = list.find(i=>i.id===id);
            if(t) { t.name=name; localStorage.setItem('mirror_energy_history',JSON.stringify(list)); openHistory(); }
        }
    }
    function loadHistoryItem(id) {
        if(event.target.tagName==='INPUT' || event.target.tagName==='BUTTON') return;
        const item = getHistory().find(i=>i.id===id);
        if(item) {
            closeModal('history-modal');
            document.getElementById('right-sidebar').style.display = 'none';
            document.getElementById('step-container').style.display = 'none';
            document.getElementById('game-area').innerHTML = '';
            startGame(item);
        }
    }
</script>
</body>
</html>