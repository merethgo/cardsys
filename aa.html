<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- æ ¸å¿ƒä¿®æ”¹ï¼šæ·»åŠ è§†å£è®¾ç½®ï¼Œç¦æ­¢ç¼©æ”¾ï¼Œé€‚é…ç§»åŠ¨ç«¯ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é•œåƒèƒ½é‡æŠ½å¡ç³»ç»Ÿ (v12 ç§»åŠ¨é€‚é…ç‰ˆ)</title>
    <style>
        :root {
            /* æ¡Œé¢ç«¯é»˜è®¤å°ºå¯¸ */
            --card-width: 140px;
            --card-height: 250px;
            --gap-size: 15px;
            
            --primary-gold: #d4af37;
            --bg-color: #000000;
        }

        /* ================= ç§»åŠ¨ç«¯é€‚é…æ ¸å¿ƒä»£ç  ================= */
        @media (max-width: 768px) {
            :root {
                /* æ‰‹æœºç«¯å°ºå¯¸ï¼šç¼©å°å¡ç‰Œä»¥é€‚åº”ç«–å± */
                --card-width: 85px;
                --card-height: 150px;
                --gap-size: 10px;
            }
            
            #step-container {
                width: 95% !important;
                padding: 20px !important;
                margin-top: 20px !important;
            }
            
            h2 { font-size: 1.2rem; }
            
            /* è°ƒæ•´æ‰‹æœºä¸Šçš„é—´è· */
            .layout-3 { gap: 15px !important; }
            
            /* ä¾§è¾¹æ è°ƒæ•´åˆ°å³ä¸‹è§’ï¼Œå˜å° */
            #right-sidebar {
                right: 10px !important;
                padding: 10px !important;
            }
            #lock-btn {
                width: 50px !important;
                height: 50px !important;
                font-size: 20px !important;
            }
            
            /* æ‰‹æœºä¸Šéšè—Tooltipï¼Œæ‰‹æŒ‡æŒ¡ä½çœ‹ä¸è§ */
            .sidebar-tooltip { display: none !important; }
            
            /* å†å²è®°å½•å¼¹çª—é€‚é… */
            #history-content {
                width: 95% !important;
                height: 80vh !important;
                padding: 15px !important;
            }
        }
        /* ==================================================== */

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: #ecf0f1;
            margin: 0;
            overflow-x: hidden; /* é˜²æ­¢æ¨ªå‘æ»šåŠ¨ */
            display: flex;
            flex-direction: column;
            height: 100vh;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç‚¹å‡»é«˜äº® */
        }

        /* å¼•å¯¼é¡µ */
        #intro-screen {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 1s ease;
        }
        #intro-img {
            width: 150px; height: auto; margin-bottom: 40px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.1));
        }
        .intro-text {
            font-size: 20px; letter-spacing: 3px; font-weight: 300;
            margin-bottom: 50px; font-family: 'KaiTi', 'æ¥·ä½“', serif; color: #aaa; text-align: center;
        }
        .enter-btn {
            padding: 10px 40px; background: transparent;
            border: 1px solid #666; color: #d4af37;
            font-size: 16px; cursor: pointer; transition: all 0.3s;
            border-radius: 30px; text-transform: uppercase; letter-spacing: 2px;
        }

        /* å¯¼èˆª */
        #navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; box-sizing: border-box; z-index: 5000; pointer-events: none; 
        }
        .nav-btn {
            pointer-events: auto; background: rgba(0,0,0,0.8);
            border: 1px solid #444; color: #ccc; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; gap: 5px;
        }

        /* ä¸»ç•Œé¢ */
        #main-app {
            display: none; flex-direction: column; align-items: center;
            width: 100%; min-height: 100vh; padding-top: 50px; 
        }

        #step-container {
            margin-top: 50px; text-align: center;
            background: rgba(20, 20, 20, 0.95); border: 1px solid #333;
            padding: 40px; border-radius: 8px; max-width: 600px; width: 90%; z-index: 100;
        }
        .step-section { display: none; animation: fadeIn 0.5s; }
        .step-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { color: var(--primary-gold); margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        
        .action-btn {
            padding: 12px 30px; background-color: var(--primary-gold); color: #000;
            border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
            font-size: 16px; margin-top: 25px; transition: 0.3s;
        }
        
        label { margin: 0 10px; cursor: pointer; font-size: 16px; display:inline-block; margin-bottom:10px; }
        input[type="number"] {
            background: #222; border: 1px solid #555; color: #fff;
            padding: 10px; width: 50px; text-align: center; margin: 5px;
            font-size: 16px; border-radius: 4px;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        #game-area {
            flex-grow: 1; width: 100%;
            display: flex; justify-content: center; align-items: center;
            position: relative; 
            box-sizing: border-box; 
            padding-bottom: 80px;
            /* æ‰‹æœºä¸Šå¯èƒ½éœ€è¦ä¸€ç‚¹é¡¶éƒ¨é—´è· */
            padding-top: 20px;
        }

        .layout-container {
            display: grid; 
            justify-items: center; align-items: center;
        }

        .layout-1 { grid-template-columns: 1fr; }
        .layout-3 { 
            grid-template-columns: 1fr; 
            grid-template-rows: repeat(3, auto); 
            gap: 20px; 
        }
        .layout-5 {
            display: grid;
            grid-template-columns: var(--card-width) var(--card-width) var(--card-width);
            grid-template-rows: var(--card-height) var(--card-height) var(--card-height);
            gap: var(--gap-size); 
        }
        
        .slot-pos-0 { grid-column: 2; grid-row: 2; } 
        .slot-pos-1 { grid-column: 1; grid-row: 2; } 
        .slot-pos-2 { grid-column: 3; grid-row: 2; } 
        .slot-pos-3 { grid-column: 2; grid-row: 1; } 
        .slot-pos-4 { grid-column: 2; grid-row: 3; } 

        .card-slot {
            width: var(--card-width); height: var(--card-height);
            border: 1px dashed #444; background-color: rgba(255, 255, 255, 0.02);
            border-radius: 6px; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .card-slot.drag-over { border-color: var(--primary-gold); }

        .card-entity {
            width: 100%; height: 100%; perspective: 1000px;
            position: relative; z-index: 10;
        }
        /* æ‹–æ‹½æ—¶éšè—æ­£é¢çš„é€»è¾‘ä¿æŒä¸å˜ */
        .card-entity:not(.flipped).dragging .card-front {
            visibility: hidden !important; opacity: 0 !important;
        }

        .card-inner {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0.2, 0.2, 1);
            border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            background: #000;
        }
        .card-entity.flipped .card-inner { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; justify-content: center; align-items: center;
            border-radius: 6px; overflow: hidden;
            background: #111; border: 1px solid #333;
        }
        .card-back {
            background-image: repeating-linear-gradient(45deg, #1a1a1a 0, #1a1a1a 10px, #222 10px, #222 20px);
            color: var(--primary-gold);
        }
        .card-front { transform: rotateY(180deg); background: #000; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .input-num-display {
            font-size: 1.2em; font-weight: bold; border: 1px solid var(--primary-gold);
            border-radius: 50%; width: 30px; height: 30px; line-height: 30px; text-align: center; background: #000;
        }

        /* æ¢ç‰ŒæŒ‰é’® */
        .slot-action-btn {
            position: absolute; 
            bottom: -25px; 
            width: 20px; height: 20px; 
            background: transparent; border: none; color: #444; 
            cursor: pointer; display: none;
            justify-content: center; align-items: center;
            z-index: 50; transition: all 0.4s; 
            font-size: 12px; font-weight: bold;
            /* æ‰‹æœºä¸Šå¢åŠ è§¦æ‘¸åŒºåŸŸ */
            padding: 10px; margin-bottom: -10px; 
        }
        .slot-action-btn:hover { color: var(--primary-gold); transform: rotate(180deg) scale(1.2); }

        /* å³ä¾§è¾¹æ  */
        #right-sidebar {
            position: fixed; right: 20px; top: 50%; transform: translateY(-50%);
            display: none; flex-direction: column; gap: 15px;
            z-index: 4000; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 12px;
        }
        #lock-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--primary-gold); border: none; cursor: pointer;
            box-shadow: 0 0 15px rgba(212,175,55,0.4); font-size: 24px;
            display: flex; justify-content: center; align-items: center; transition: 0.3s;
        }
        #lock-btn:disabled { background: #333; color: #666; cursor: default; box-shadow: none; transform: none;}
        
        .sidebar-tooltip {
            position: absolute; right: 80px; top: 50%; transform: translateY(-50%);
            background: #222; padding: 5px 10px; border-radius: 4px;
            font-size: 12px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #right-sidebar:hover .sidebar-tooltip { opacity: 1; }

        /* æ¨¡æ€æ¡† */
        #history-modal, #image-modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.95);
            z-index: 9000; justify-content: center; align-items: center;
        }
        #history-content {
            background: #111; width: 600px; max-width: 90%; height: 75vh;
            border: 1px solid #333; border-radius: 8px; padding: 25px; display: flex; flex-direction: column;
        }
        .history-list { flex-grow: 1; overflow-y: auto; margin-top: 10px; border-top: 1px solid #333; }
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid #222; transition: 0.2s;
        }
        
        .h-info { display: flex; flex-direction: column; gap: 5px; cursor: pointer; flex-grow: 1; }
        .h-name { color: var(--primary-gold); font-weight: bold; font-size: 14px; }
        .h-actions button { background: none; border: none; cursor: pointer; color: #666; padding: 5px; font-size: 16px; }
        
        .h-checkbox-wrapper { margin-right: 15px; }
        .h-item-checkbox { transform: scale(1.3); cursor: pointer; }
        
        #btn-batch-del {
            background: #c0392b; color: #fff; border: none;
            padding: 5px 12px; border-radius: 4px; cursor: pointer;
            font-size: 14px; margin-right: 15px; display: none;
        }

        #modal-img { max-width: 95%; max-height: 80%; border: 2px solid #333; border-radius: 8px; }

    </style>
</head>
<body>

<div id="intro-screen">
    <img id="intro-img" src="" alt="Enso Circle">
    <div class="intro-text">ä»¥ç¥ä¹‹åå¼€å¯é•œåƒèƒ½é‡</div>
    <button class="enter-btn" onclick="enterSystem()">å¼€å¯è¿æ¥</button>
</div>

<nav id="navbar">
    <button class="nav-btn" onclick="goHome()"><span>ğŸ </span> ä¸»é¡µ</button>
    <button class="nav-btn" onclick="openHistory()"><span>ğŸ“œ</span> è®°å½•</button>
</nav>

<div id="main-app">
    <div id="step-container">
        <div id="step-setup" class="step-section active">
            <h2>é€‰æ‹©ç‰Œé˜µ</h2>
            <div style="margin: 30px 0; display:flex; flex-wrap:wrap; justify-content:center; gap:20px;">
                <label><input type="radio" name="cardCount" value="1"> 1 å¼ </label>
                <label><input type="radio" name="cardCount" value="3"> 3 å¼  (ç«–åˆ—)</label>
                <label><input type="radio" name="cardCount" value="5" checked> 5 å¼  (åå­—)</label>
            </div>
            <button class="action-btn" onclick="goToStepInput()">ä¸‹ä¸€æ­¥ï¼šæ´—ç‰Œ</button>
        </div>

        <div id="step-input" class="step-section">
            <h2>æ„ŸçŸ¥è¿æ¥</h2>
            <p style="color:#888; font-size:12px; margin-bottom: 20px;">
                ç‰Œå †å·²éšæœºé‡ç½®ã€‚è¯·å‡­ç›´è§‰è¾“å…¥ 1-69 ä¹‹é—´çš„æ•°å­—ã€‚
            </p>
            <div id="input-container" style="margin: 20px 0; display:flex; flex-wrap:wrap; justify-content:center;"></div>
            <button class="action-btn" onclick="startGame()">å¼€å§‹æŠ½ç‰Œ</button>
        </div>
    </div>

    <div id="game-area"></div>
</div>

<div id="right-sidebar">
    <button id="lock-btn" onclick="lockAndFlip()">ğŸ”’</button>
    <div class="sidebar-tooltip" id="sidebar-hint">é”å®šå¹¶ç¿»ç‰Œ</div>
</div>

<div id="history-modal">
    <div id="history-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0; border:none; font-size:18px;">å†å²è®°å½•</h2>
            <div style="display:flex; align-items:center;">
                <button id="btn-batch-del" onclick="deleteSelected()">åˆ é™¤</button>
                <button onclick="closeHistory()" style="background:none; border:none; color:#fff; cursor:pointer; font-size:24px;">âœ•</button>
            </div>
        </div>
        
        <div style="padding-bottom:10px; border-bottom:1px solid #333; display:flex; align-items:center;">
            <label style="color:#aaa; font-size:14px; cursor:pointer; display:flex; align-items:center;">
                <input type="checkbox" id="chk-all" onchange="toggleSelectAll(this)" style="margin-right:8px; transform:scale(1.2);"> 
                å…¨é€‰
            </label>
        </div>

        <div class="history-list" id="history-list-box"></div>
    </div>
</div>

<div id="image-modal" onclick="closeImageModal()">
    <img id="modal-img" src="" alt="Zoomed Card">
</div>

<script>
    // ================= é…ç½® =================
    const USE_ONLINE_DEMO = false; 
    const TOTAL_CARDS = 69;
    // =======================================

    let deck = [];
    let selectedCount = 5;
    let isFlippingAllowed = false;
    let isReviewMode = false;
    let draggedCard = null;
    let currentRecord = null; 

    window.onload = function() {
        const introImg = document.getElementById('intro-img');
        if (USE_ONLINE_DEMO) {
            introImg.src = "https://placehold.co/150x150/000/fff?text=Zen";
        } else {
            introImg.src = "images/intro.jpg";
            introImg.onerror = function() { this.style.display = 'none'; }
        }
    };

    function enterSystem() {
        const intro = document.getElementById('intro-screen');
        intro.style.opacity = '0';
        setTimeout(() => {
            intro.style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
        }, 1000);
    }

    function goHome() {
        document.getElementById('step-container').style.display = 'block';
        document.getElementById('game-area').innerHTML = '';
        document.getElementById('right-sidebar').style.display = 'none';
        document.getElementById('step-setup').classList.add('active');
        document.getElementById('step-input').classList.remove('active');
        isFlippingAllowed = false;
        isReviewMode = false;
        currentRecord = null;
    }

    function goToStepInput() {
        const radios = document.getElementsByName('cardCount');
        for (let r of radios) if (r.checked) selectedCount = parseInt(r.value);

        deck = Array.from({length: TOTAL_CARDS}, (_, i) => i + 1);
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }

        const container = document.getElementById('input-container');
        container.innerHTML = '';
        
        let placeHolderText = ["ä¸Š", "ä¸­", "ä¸‹"];
        for (let i = 0; i < selectedCount; i++) {
            const inp = document.createElement('input');
            inp.type = 'number';
            inp.min = 1; inp.max = TOTAL_CARDS;
            if(selectedCount === 3) inp.placeholder = placeHolderText[i];
            else inp.placeholder = `#${i+1}`;
            inp.className = 'user-choice-input';
            container.appendChild(inp);
        }

        document.getElementById('step-setup').classList.remove('active');
        document.getElementById('step-input').classList.add('active');
    }

    function startGame(loadedRecord = null) {
        let inputs, chosenIndices = [];

        if (loadedRecord) {
            selectedCount = loadedRecord.layout;
            deck = loadedRecord.deckSnapshot; 
            isFlippingAllowed = true;
            isReviewMode = true;
            
            if (loadedRecord.finalState) {
                // æœ‰æœ€ç»ˆçŠ¶æ€
            } else {
                chosenIndices = loadedRecord.userIndices;
            }
        } else {
            inputs = document.querySelectorAll('.user-choice-input');
            for (let inp of inputs) {
                let val = parseInt(inp.value);
                if (isNaN(val) || val < 1 || val > TOTAL_CARDS) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— (1-69)"); return; }
                if (chosenIndices.includes(val)) { alert("æ•°å­—ä¸èƒ½é‡å¤"); return; }
                chosenIndices.push(val);
            }
            isFlippingAllowed = false;
            isReviewMode = false;
        }

        document.getElementById('step-container').style.display = 'none';
        const gameArea = document.getElementById('game-area');
        gameArea.innerHTML = ''; 
        
        const layoutDiv = document.createElement('div');
        layoutDiv.className = `layout-container layout-${selectedCount}`;
        
        for (let i = 0; i < selectedCount; i++) {
            const slot = document.createElement('div');
            
            if (selectedCount === 5) {
                slot.className = `card-slot slot-pos-${i}`;
            } else {
                slot.className = `card-slot`;
            }

            if (!isReviewMode) {
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('drop', handleDrop);
            }

            let realCardId, backNum;

            if (isReviewMode && loadedRecord.finalState) {
                realCardId = loadedRecord.finalState.cardIds[i];
                backNum = loadedRecord.finalState.backNums[i];
            } else if (isReviewMode && !loadedRecord.finalState) {
                const idx = chosenIndices[i];
                backNum = idx;
                realCardId = deck[idx - 1];
            } else {
                const idx = chosenIndices[i];
                backNum = idx;
                realCardId = deck[idx - 1];
            }

            const card = createCard(backNum, realCardId);
            
            if (!isReviewMode) {
                const replaceBtn = document.createElement('div');
                replaceBtn.className = 'slot-action-btn';
                replaceBtn.innerHTML = 'â†»';
                replaceBtn.title = "æ›´æ¢æ­¤ç‰Œ";
                replaceBtn.onclick = () => replaceCard(i, slot);
                slot.appendChild(replaceBtn);
            }
            
            if (isReviewMode) {
                card.draggable = false;
                card.style.cursor = 'pointer'; 
                card.classList.add('flipped'); 
            } else {
                card.draggable = true; 
                card.style.cursor = 'grab';
                card.addEventListener('dragstart', handleDragStart);
            }
            
            slot.appendChild(card);
            layoutDiv.appendChild(slot);
        }

        gameArea.appendChild(layoutDiv);

        const sidebar = document.getElementById('right-sidebar');
        const lockBtn = document.getElementById('lock-btn');
        const hint = document.getElementById('sidebar-hint');

        if (isReviewMode) {
            sidebar.style.display = 'none';
        } else {
            sidebar.style.display = 'flex';
            lockBtn.disabled = false;
            hint.innerText = "é”å®šå¹¶ç¿»ç‰Œ";
            prepareRecordData(chosenIndices);
        }
    }

    function createCard(backNum, realId) {
        const entity = document.createElement('div');
        entity.className = 'card-entity';
        entity.dataset.realId = realId; 

        let imgSrc = "";
        if (USE_ONLINE_DEMO) {
            imgSrc = `https://placehold.co/560x1000/222/d4af37?text=Card+${realId}`;
        } else {
            imgSrc = `images/${realId}.jpg`;
        }

        entity.innerHTML = `
            <div class="card-inner">
                <div class="card-face card-back">
                    <div class="input-num-display">${backNum}</div>
                </div>
                <div class="card-face card-front">
                    <img src="${imgSrc}" class="card-img" draggable="false" onerror="this.src='https://placehold.co/140x250/333/fff?text=Missing'">
                </div>
            </div>
        `;
        
        entity.addEventListener('click', function() {
            if (!isFlippingAllowed) {
                const inner = this.querySelector('.card-inner');
                inner.style.transform = "rotateZ(3deg)";
                setTimeout(() => inner.style.transform = "", 100);
            } else {
                if (!this.classList.contains('flipped')) this.classList.add('flipped');
            }
        });

        entity.addEventListener('dblclick', function() {
            if (this.classList.contains('flipped')) {
                const src = this.querySelector('.card-img').src;
                document.getElementById('modal-img').src = src;
                document.getElementById('image-modal').style.display = 'flex';
            }
        });

        return entity;
    }

    // --- æ‹–æ‹½ç³»ç»Ÿ ---
    function handleDragStart(e) {
        if (isReviewMode) { e.preventDefault(); return; }
        draggedCard = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => this.style.opacity = '0.5', 0);
    }
    function handleDragOver(e) {
        e.preventDefault(); if (isReviewMode) return;
        this.classList.add('drag-over'); 
        e.dataTransfer.dropEffect = 'move';
    }
    function handleDrop(e) {
        e.preventDefault(); 
        this.classList.remove('drag-over');
        if (isReviewMode || !draggedCard) return;

        const targetSlot = this; 
        const sourceSlot = draggedCard.parentNode;
        
        if (targetSlot !== sourceSlot) {
            const targetCard = targetSlot.querySelector('.card-entity');
            targetSlot.appendChild(draggedCard);
            if (targetCard) sourceSlot.appendChild(targetCard);
            updateCurrentRecordState();
            saveHistory(true); 
        }
        
        draggedCard.style.opacity = '1'; 
        draggedCard.classList.remove('dragging');
        draggedCard = null;
    }
    document.addEventListener('dragend', function() {
        if (draggedCard) {
            draggedCard.style.opacity = '1';
            draggedCard.classList.remove('dragging');
        }
        document.querySelectorAll('.card-slot').forEach(s => s.classList.remove('drag-over'));
        draggedCard = null;
    });

    // --- æ¢ç‰ŒåŠŸèƒ½ ---
    function replaceCard(slotIndex, slotElement) {
        const currentCards = document.querySelectorAll('.card-entity');
        const usedIds = Array.from(currentCards).map(c => parseInt(c.dataset.realId));
        const remainingCount = TOTAL_CARDS - usedIds.length;

        const input = prompt(`å½“å‰æ¡Œä¸Šæœ‰ ${usedIds.length} å¼ ç‰Œï¼Œå‰©ä½™ ${remainingCount} å¼ ã€‚\nè¯·è¾“å…¥ 1 åˆ° ${remainingCount} ä¹‹é—´çš„æ•°å­—ï¼Œä»å‰©ä½™ç‰Œå †ä¸­æŠ½å–ï¼š`);
        if (input === null) return; 
        
        const choice = parseInt(input);
        if (isNaN(choice) || choice < 1 || choice > remainingCount) {
            alert("æ— æ•ˆè¾“å…¥ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„èŒƒå›´å†…æ•°å­—ã€‚");
            return;
        }

        const oldCard = slotElement.querySelector('.card-entity');
        const remainingDeck = deck.filter(id => !usedIds.includes(id));
        const newId = remainingDeck[choice - 1];

        slotElement.removeChild(oldCard);

        const backNumText = oldCard.querySelector('.input-num-display').innerText;
        const newCard = createCard(backNumText, newId);
        newCard.draggable = true;
        newCard.style.cursor = 'grab';
        newCard.addEventListener('dragstart', handleDragStart);
        newCard.classList.add('flipped');
        
        slotElement.appendChild(newCard); 

        saveAsNewRecord();
    }

    // --- å†å²è®°å½• ---

    function prepareRecordData(chosenIndices) {
        currentRecord = {
            id: Date.now(),
            name: new Date().toLocaleString(),
            layout: selectedCount,
            userIndices: chosenIndices, 
            deckSnapshot: [...deck],   
            finalState: null           
        };
    }

    function updateCurrentRecordState() {
        if (!currentRecord) return;
        const slots = document.querySelectorAll('.card-slot');
        const ids = [];
        const backs = [];
        slots.forEach(slot => {
            const card = slot.querySelector('.card-entity');
            if(card) {
                ids.push(parseInt(card.dataset.realId));
                backs.push(parseInt(card.querySelector('.input-num-display').innerText));
            }
        });
        currentRecord.finalState = {
            cardIds: ids,
            backNums: backs
        };
    }

    function lockAndFlip() {
        isFlippingAllowed = true;
        document.getElementById('lock-btn').innerHTML = "âœ“";
        document.getElementById('lock-btn').disabled = true;
        document.getElementById('sidebar-hint').innerText = "å¯ç¿»ç‰Œ / æ‹–æ‹½ / æ¢ç‰Œ";
        document.querySelectorAll('.slot-action-btn').forEach(b => b.style.display = 'flex');
        updateCurrentRecordState();
        saveHistory(false); 
    }

    function saveAsNewRecord() {
        updateCurrentRecordState(); 
        const newRecord = JSON.parse(JSON.stringify(currentRecord));
        newRecord.id = Date.now();
        if (!newRecord.name.includes("(æ›´æ¢")) {
            newRecord.name += " (æ›´æ¢)";
        } else {
            const timeStr = new Date().toLocaleTimeString();
            newRecord.name = newRecord.name.split(" - ")[0] + " - " + timeStr + " (æ›´æ¢)";
        }
        currentRecord = newRecord;
        saveHistory(false); 
    }

    function saveHistory(updateExisting = false) {
        if (!currentRecord) return;
        const list = getHistory();
        if (updateExisting) {
            const idx = list.findIndex(i => i.id === currentRecord.id);
            if (idx !== -1) list[idx] = currentRecord;
            else list.unshift(currentRecord);
        } else {
            list.unshift(currentRecord);
        }
        localStorage.setItem('mirror_energy_history', JSON.stringify(list));
    }
    
    function getHistory() {
        const raw = localStorage.getItem('mirror_energy_history');
        return raw ? JSON.parse(raw) : [];
    }
    
    // --- è¾…åŠ©åŠŸèƒ½ ---
    function closeImageModal() { document.getElementById('image-modal').style.display = 'none'; }
    function closeHistory() { document.getElementById('history-modal').style.display = 'none'; }
    
    function openHistory() {
        const modal = document.getElementById('history-modal');
        const listContainer = document.getElementById('history-list-box');
        const list = getHistory();
        
        document.getElementById('chk-all').checked = false;
        document.getElementById('btn-batch-del').style.display = 'none';
        
        listContainer.innerHTML = '';
        if (list.length === 0) listContainer.innerHTML = '<div style="color:#666;text-align:center;margin-top:50px;">æš‚æ— è®°å½•</div>';
        
        list.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div class="h-checkbox-wrapper">
                    <input type="checkbox" class="h-item-checkbox" value="${item.id}" onchange="updateBatchBtn()">
                </div>
                <div class="h-info" onclick="loadHistoryItem(${item.id})">
                    <div class="h-name"><span>${item.name}</span> <span style="font-size:12px;border:1px solid #444;padding:0 5px;">${item.layout}å¼ </span></div>
                    <div class="h-date">${new Date(item.id).toLocaleString()}</div>
                </div>
                <div class="h-actions">
                    <button onclick="editName(${item.id})">âœï¸</button> <button onclick="deleteItem(${item.id})">ğŸ—‘ï¸</button>
                </div>`;
            listContainer.appendChild(div);
        });
        modal.style.display = 'flex';
    }

    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('.h-item-checkbox');
        checkboxes.forEach(chk => chk.checked = source.checked);
        updateBatchBtn();
    }

    function updateBatchBtn() {
        const checkboxes = document.querySelectorAll('.h-item-checkbox:checked');
        const btn = document.getElementById('btn-batch-del');
        if (checkboxes.length > 0) {
            btn.style.display = 'block';
            btn.innerText = `åˆ é™¤é€‰ä¸­ (${checkboxes.length})`;
        } else {
            btn.style.display = 'none';
        }
    }

    function deleteSelected() {
        const checkboxes = document.querySelectorAll('.h-item-checkbox:checked');
        if (checkboxes.length === 0) return;
        
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} æ¡è®°å½•å—ï¼Ÿ`)) return;

        const idsToDelete = Array.from(checkboxes).map(chk => parseInt(chk.value));
        let list = getHistory();
        list = list.filter(item => !idsToDelete.includes(item.id));
        
        localStorage.setItem('mirror_energy_history', JSON.stringify(list));
        openHistory(); 
    }

    function editName(id) {
        const newName = prompt("æ–°åç§°ï¼š");
        if(newName) {
            const list = getHistory();
            const t = list.find(i=>i.id===id);
            if(t) { t.name=newName; localStorage.setItem('mirror_energy_history',JSON.stringify(list)); openHistory(); }
        }
    }
    function deleteItem(id) {
        if(!confirm("åˆ é™¤ï¼Ÿ")) return;
        let list = getHistory(); list = list.filter(i=>i.id!==id);
        localStorage.setItem('mirror_energy_history',JSON.stringify(list)); openHistory();
    }
    function loadHistoryItem(id) {
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'BUTTON') return;
        const list = getHistory(); const item = list.find(i=>i.id===id);
        if(item) {
            closeHistory();
            document.getElementById('right-sidebar').style.display = 'none';
            document.getElementById('step-container').style.display = 'none';
            document.getElementById('game-area').innerHTML = '';
            startGame(item);
        }
    }

</script>
</body>
</html>
